<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Justice City Viewer</title>

  <link rel="stylesheet" href="https://cesium.com/downloads/cesiumjs/releases/1.120/Build/Cesium/Widgets/widgets.css">
  <style>
    html,body,#cesium{height:100%;margin:0}
    body{background:#0b1a2b}
    #msg{position:absolute;top:10px;left:10px;background:rgba(0,0,0,.75);color:#fff;
         padding:8px 10px;border-radius:6px;font:14px system-ui,sans-serif;max-width:540px;display:none}
  </style>
  <script>window.CESIUM_BASE_URL="https://cesium.com/downloads/cesiumjs/releases/1.120/Build/Cesium/";</script>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.120/Build/Cesium/Cesium.js"></script>
</head>
<body>
  <div id="cesium"></div>
  <div id="msg"></div>

  <script>
    const show = (t)=>{ const m=document.getElementById("msg"); m.textContent=t; m.style.display="block"; };

    // --- Token ---
    Cesium.Ion.defaultAccessToken=
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIzMTJhNDRjOS0yMGQ0LTQ3MTctODI0OC00NjBmNTJhZDg2MTgiLCJpZCI6MzM2ODExLCJpYXQiOjE3NTcwMTMyMTR9.zRV7TVzrkTXHHEdqQFJMqqO33PoBHTLtbpy3unjefHc";

    // --- Viewer (start simple so something always draws) ---
    const viewer = new Cesium.Viewer("cesium", {
      baseLayerPicker:false, timeline:false, animation:false, geocoder:false, sceneModePicker:true
    });

    // Neutral OSM background (no purple)
    viewer.imageryLayers.removeAll();
    const base = viewer.imageryLayers.addImageryProvider(
      new Cesium.UrlTemplateImageryProvider({
        url:"https://tile.openstreetmap.org/{z}/{x}/{y}.png",
        credit:"© OpenStreetMap contributors"
      })
    );
    // reset all imagery adjustments to default neutral
    base.alpha = 1.0; base.brightness = 1.0; base.contrast = 1.0;
    base.hue = 0.0; base.saturation = 0.0; base.gamma = 1.0;

    // Fly to your site right away
    const LON=-87.8451909767, LAT=41.7427949281;
    viewer.camera.setView({
      destination: Cesium.Cartesian3.fromDegrees(LON, LAT, 450),
      orientation: { heading:0, pitch: Cesium.Math.toRadians(-35), roll:0 }
    });

    // --- Try to enable World Terrain explicitly (assetId 1) ---
    (async ()=>{
      try {
        const terrain = await Cesium.CesiumTerrainProvider.fromIonAssetId(1); // World Terrain
        viewer.terrainProvider = terrain;
        viewer.scene.globe.depthTestAgainstTerrain = true;
      } catch (e) {
        console.warn("Terrain failed:", e);
        show("Terrain unavailable (token/network). Showing flat map. If your model looks high, use [ / ] to nudge.");
      }
    })();

    // --- Load your tileset ---
    const ASSET_ID = 3691052;

    (async ()=>{
      try {
        const tileset = await Cesium.Cesium3DTileset.fromIonAssetId(ASSET_ID);
        viewer.scene.primitives.add(tileset);
        await tileset.readyPromise;
        viewer.flyTo(tileset, { duration: 1.2 });

        // Quick height nudge keys in case terrain is blocked
        let h=0;
        function setH(v){
          h=v;
          const c=tileset.boundingSphere.center, ct=Cesium.Cartographic.fromCartesian(c);
          const s=Cesium.Cartesian3.fromRadians(ct.longitude, ct.latitude, 0.0);
          const o=Cesium.Cartesian3.fromRadians(ct.longitude, ct.latitude, h);
          tileset.modelMatrix = Cesium.Matrix4.fromTranslation(
            Cesium.Cartesian3.subtract(o, s, new Cesium.Cartesian3())
          );
        }
        window.addEventListener("keydown",(e)=>{
          if(e.key===']') setH(h+1);
          if(e.key==='[') setH(h-1);
          if(e.key==='}') setH(h+10);
          if(e.key==='{') setH(h-10);
        });
      } catch (e) {
        console.warn("Tileset failed:", e);
        show("Couldn’t load your 3D tileset (check asset ID/token/network).");
      }
    })();
  </script>
</body>
</html>
